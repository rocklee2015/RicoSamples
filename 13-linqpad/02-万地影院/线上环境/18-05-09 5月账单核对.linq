<Query Kind="Statements">
  <Connection>
    <ID>edb569e0-1029-4670-bd56-f4981986d255</ID>
    <Persist>true</Persist>
    <Server>101.132.69.71</Server>
    <SqlSecurity>true</SqlSecurity>
    <UserName>sa</UserName>
    <Password>AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAABoybHsSXFUuz8AXaKmCqgAAAAAACAAAAAAAQZgAAAAEAACAAAADlMDTg8rh8stUlZgjvxKWfJkLaoJu5GrJnhua9EICUhQAAAAAOgAAAAAIAACAAAAB7x+0HnQ6b0YgF1diupbyFoqj8o5uo5sGeSJrsiKJKHBAAAABM8IUq4NDIt9vX4B4yLwcyQAAAAJFB1V+gp2sgHISifMpmzqEsGAOnWOnhx7O3RcsGhbmZYn41eVGBCO7ch97kncwveJgTFqk5lA+bm4awvliGAl0=</Password>
    <Database>CinemaWd</Database>
    <ShowServer>true</ShowServer>
  </Connection>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Antlr3.Runtime.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.AppWeb.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.Audit.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.Caches.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.Core.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.SmsService.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.Util.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.YueKe.Service.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Domain.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Domain.Identity.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Storage.EntityFramework.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Storage.EntityFramework.Identity.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Thirdparty.Alipay.AppPay.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Thirdparty.Wechat.AppPay.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.Configuration.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.Exceptional.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.Http.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.Logger.Ado.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.Serialization.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Web.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Web.Identity.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\EntityFramework.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\EntityFramework.SqlServer.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.AspNet.Identity.Core.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.AspNet.Identity.Owin.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.CodeDom.Providers.DotNetCompilerPlatform.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Owin.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Owin.Host.SystemWeb.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Owin.Security.Cookies.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Owin.Security.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Owin.Security.OAuth.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.ServiceLocation.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.Unity.Configuration.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.Unity.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.Unity.Interception.Configuration.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.Unity.Interception.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.Unity.RegistrationByConvention.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Web.Infrastructure.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Newtonsoft.Json.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Owin.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\StackExchange.Redis.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Net.Http.Extensions.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Net.Http.Formatting.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Net.Http.Primitives.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Helpers.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Http.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Http.Owin.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Mvc.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Optimization.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Razor.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Webpages.Deployment.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Webpages.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Webpages.Razor.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\WebGrease.dll</Reference>
  <Namespace>Cinema.Core.Domain.Models.Values</Namespace>
</Query>

// 第一步 ：先算出来这个月的总额和支付宝，微信的是否能对的的上？差额多少

// 第二步：将每一个订单和支付宝或微信进行核对。找出不符合订单。

//查询
var query = Orders
.Where(a => a.PayTime > DateTime.Now.AddMonths(0).GetMonthFirstDay().AddHours(6))
.Where(a => a.PayTime < DateTime.Now.AddMonths(1).GetMonthFirstDay().AddHours(6))
.Where(a => a.Status > (int)OrderStatus.NoPay && a.Status < (int)OrderStatus.Deleted)
//.Where(a=>a.PayType!=(int)PayType.LeaguerPay)
;
query.Where(a=>a.PayType==(int)PayType.Alipay).Count().Dump("支付宝多少笔订单");
query.Where(a=>a.PayType==(int)PayType.WechatPay).Count().Dump("微信多少笔订单");
query.Where(a=>a.PayType==(int)PayType.LeaguerPay).Count().Dump("会员卡多少笔订单");
//分组
var result=query.GroupBy(a => a.PayType).ToList();

//汇总
var sumResult=result.Select(a => new {
支付方式=((PayType)a.Key).ReadEnumDescription(),
订单金额=a.Sum(b=>b.ThirdPay)
});
//sumResult.Sum(a=>a.订单金额).Dump("订单金额为");
sumResult.Dump("月账单总额汇总");

var dateGroup = query
.OrderBy(a => a.PayTime)
.GroupBy(a => a.PayTime.Value.Date).ToList();

dateGroup.Select(a => new {
a.Key,
非会员总额=a.Where(b=>b.PayType!=(int)PayType.LeaguerPay).Sum(b=>b.ThirdPay)-a.Where(b=>b.PayType!=(int)PayType.LeaguerPay).Sum(b=>b.TicketCount)*1,
会员总额=a.Where(b=>b.PayType==(int)PayType.LeaguerPay).Sum(b=>b.ThirdPay)-a.Where(b=>b.PayType==(int)PayType.LeaguerPay).Sum(b=>b.TicketCount)*1
}).Dump("每日订单汇总");
