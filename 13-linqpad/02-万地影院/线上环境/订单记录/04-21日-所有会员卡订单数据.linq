<Query Kind="Statements">
  <Connection>
    <ID>edb569e0-1029-4670-bd56-f4981986d255</ID>
    <Persist>true</Persist>
    <Server>101.132.69.71</Server>
    <SqlSecurity>true</SqlSecurity>
    <UserName>sa</UserName>
    <Password>AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAABoybHsSXFUuz8AXaKmCqgAAAAAACAAAAAAAQZgAAAAEAACAAAADlMDTg8rh8stUlZgjvxKWfJkLaoJu5GrJnhua9EICUhQAAAAAOgAAAAAIAACAAAAB7x+0HnQ6b0YgF1diupbyFoqj8o5uo5sGeSJrsiKJKHBAAAABM8IUq4NDIt9vX4B4yLwcyQAAAAJFB1V+gp2sgHISifMpmzqEsGAOnWOnhx7O3RcsGhbmZYn41eVGBCO7ch97kncwveJgTFqk5lA+bm4awvliGAl0=</Password>
    <Database>CinemaWd</Database>
    <ShowServer>true</ShowServer>
  </Connection>
  <Output>DataGrids</Output>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Antlr3.Runtime.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.AppWeb.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.Audit.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.Caches.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.Core.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.SmsService.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.Util.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Cinema.YueKe.Service.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Domain.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Domain.Identity.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Storage.EntityFramework.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Storage.EntityFramework.Identity.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Thirdparty.Alipay.AppPay.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Thirdparty.Wechat.AppPay.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.Configuration.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.Exceptional.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.Http.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.Logger.Ado.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Utility.Serialization.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Web.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\DRapid.Web.Identity.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\EntityFramework.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\EntityFramework.SqlServer.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.AspNet.Identity.Core.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.AspNet.Identity.Owin.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.CodeDom.Providers.DotNetCompilerPlatform.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Owin.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Owin.Host.SystemWeb.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Owin.Security.Cookies.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Owin.Security.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Owin.Security.OAuth.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.ServiceLocation.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.Unity.Configuration.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.Unity.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.Unity.Interception.Configuration.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.Unity.Interception.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Practices.Unity.RegistrationByConvention.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Microsoft.Web.Infrastructure.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Newtonsoft.Json.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\Owin.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\StackExchange.Redis.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Net.Http.Extensions.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Net.Http.Formatting.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Net.Http.Primitives.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Helpers.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Http.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Http.Owin.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Mvc.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Optimization.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Razor.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Webpages.Deployment.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Webpages.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\System.Web.Webpages.Razor.dll</Reference>
  <Reference>D:\00-baitu-tfs\TFS-2013\Cinema\master\src\Cinema.AppWeb\bin\WebGrease.dll</Reference>
  <Namespace>Cinema.Core.Domain.Models.Values</Namespace>
</Query>


var bookingIds = new List<string>()
{
"1185018042174944",
"1185018042175152",
"1185018042175480",
"1185018042175442",
"1185018042175218",
"1185018042174944",
"1185018042175152",
"1185018042175513",
"1185018042175356",
"1185018042174973",
"1185018042175868",
"1185018042175723",
"1185018042175502",
"1185018042175513",
"1185018042175513",
"1185018042175627",
"1185018042175627",
"1185018042175174",
"1185018042175153",
"1185018042175218",
"1185018042174984",
"1185018042175936",
"1185018042175226",
"1185018042175174",
"1185018042175356",
"1185018042175526",
"1185018042175526",
"1185018042174944",
"1185018042175522",
"1185018042175216",
"1185018042175152",
"1185018042175152",
"1185018042175723",
"1185018042175226",
"1185018042175522",
"1185018042175502",
"1185018042175936",
"1185018042175522",
"1185018042175442",
"1185018042174973",
"1185018042175216",
"1185018042175216",
"1185018042175781",
};

//bookingIds = bookingIds.Distinct().ToList();
bookingIds.Dump();
//可以确定这些用户是先用会员卡支付，然后又用支付宝或微信支付。
var result = Orders.OrderByDescending(a => a.CreateTime)
.Where(a=>a.PayType==(int)PayType.LeaguerPay)
.Where(a => a.Status > (int)OrderStatus.NoPay && a.Status <(int) OrderStatus.Deleted)
.Where(a => a.CreateTime > DateTime.Parse("2018-04-21 06:00") && a.CreateTime < DateTime.Parse("2018-04-22 06:00"))
.Take(100).ToList().Select(a => new
{
	创建时间 = a.CreateTime.ToString("yyyy-MM-dd HH:mm:ss"),
	电影名 = FilmSchedules.FirstOrDefault(b => b.ScheduleId == a.FilmScheduleId).FilmName,
	状态 = ((OrderStatus)a.Status).ReadEnumDescription(),
	支付方式 = ((PayType)a.PayType).ReadEnumDescription(),
	是否包涵在退票 = bookingIds.Contains(a.BookingId),
	a.TicketCount,
	a.OldTotal,
	a.Total,
	a.CardTotal,
	a.ThirdPay,
	去除手续费 = a.ThirdPay - a.TicketCount * 1,
	昵称 = Users.FirstOrDefault(b => b.Id == a.UserId).NickName,
	a.Mobile,

	a.PayCardNum,
	a.BookingId,
	a.ConfirmationId,
	a.OrderCode,
	a.MerchantOrderId,
	a.ThirdpartyOrderId,
	a.LimitDiscountId,
	a.RedPacketId,
	a.GoodsTotal,
	a.TotalGoodsFee,
	a.PickUpCode,
	a.HoldId,
	a.Id,
	a.LockOrderId,
	a.OutLockId,


	a.ExpireTime,
	a.FilmScheduleId,
	a.PayType,
	付款时间 = a.PayTime.ToString("yyyy-MM-dd HH:mm:ss"),

});
result.Dump("订单");
bookingIds.Except(result.Select(a=>a.BookingId).ToList()).Dump("差集");;



